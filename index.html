<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Tcga-cluster-scripts by kevchn</title>

    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/github-dark.css">
    <script src="javascripts/scale.fix.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="wrapper">
      <header>
        <h1>Tcga-cluster-scripts</h1>
        <p>A short guide to downloading and manipulating TCGA data on a TCGA cluster</p>
        <p class="view"><a href="https://github.com/kevchn/tcga-cluster-scripts">View the Project on GitHub <small>kevchn/tcga-cluster-scripts</small></a></p>
        <ul>
          <li><a href="https://github.com/kevchn/tcga-cluster-scripts/zipball/master">Download <strong>ZIP File</strong></a></li>
          <li><a href="https://github.com/kevchn/tcga-cluster-scripts/tarball/master">Download <strong>TAR Ball</strong></a></li>
          <li><a href="https://github.com/kevchn/tcga-cluster-scripts">View On <strong>GitHub</strong></a></li>
        </ul>
      </header>
      <section>
        <h1>
<a id="genomic-data-commons" class="anchor" href="#genomic-data-commons" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Genomic Data Commons</h1>

<p><a href="https://gdc.nci.nih.gov/access-data/gdc-data-portal">Introduction to the GDC Portal</a></p>

<p><a href="https://gdc-portal.nci.nih.gov/search/s">GDC Data Portal for TCGA Data</a></p>

<p><a href="https://gdc-docs.nci.nih.gov/Data_Transfer_Tool/Users_Guide/">Guide to Downloading TCGA Data using the New GDC</a></p>

<p><a href="https://gdc.nci.nih.gov/access-data/data-access-processes-and-tools">Which GDC tools to use to download TCGA data</a></p>

<hr>

<h1>
<a id="introduction-to-the-atrf-cluster" class="anchor" href="#introduction-to-the-atrf-cluster" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Introduction to the ATRF Cluster</h1>

<p>The NCI-ATRF cluster, which is a Moab HPC cluster, is a system of connected nodes, each representing a computer. When you first connect to the cluster <em>(see Sample Workflow: Connecting to the Cluster)</em>, you will be connected to the head node, which you can use for basic commands (ls, cd, mkdir), but you should not use it for any extensive scripts (otherwise it will slow down everyone else at NCI connected to the server on the head node).</p>

<p>Because of this, you should request a node to use in interactive mode <code>qsub -I</code> as soon as you connect, which essentially is allowing you to use a computer in the cluster that no one else is using. You can run small programs in this mode without doing anything else (./my-small-program), but this prevents you from being able to turn off your computer or closing the terminal without stopping whatever programs you ran in this node.</p>

<p>To allow programs to run 24/7 on the server regardless of whether your computer is on, you will need to submit a <strong><em>job</em></strong> to the server, which you can do with or without having started an interactive <code>qsub -I</code> node. To submit a job, you will first need to create a <strong><em>job file</em></strong> (call it myjobfile.pbs) in this format:</p>

<div class="highlight highlight-source-shell"><pre><span class="pl-c">#!/bin/bash</span>
<span class="pl-c">#PBS -l nodes=1:ppn=1</span>

<span class="pl-c1">cd</span> <span class="pl-smi">$PBS_O_WORKDIR</span>
<span class="pl-c1">echo</span> <span class="pl-s"><span class="pl-pds">'</span>Hello World<span class="pl-pds">'</span></span> <span class="pl-k">&gt;</span> output.txt</pre></div>

<p>The first line is just a header to tell the interpreter to run bash.</p>

<p>The second line starting with #PBS, is an option saying to run the job with 1 node and 1 processor. PBS options allow you to specify how you want the job to run (maximum time before it closes, how many processors to use, whether to email you if the job has finished, etc).</p>

<p>The third line makes use of the variable <code>$PBS_O_WORKDIR</code>, which will evaluate to the directory in which you ran the script. If you do not <code>cd $PBS_O_WORKDIR</code> at the beginning of your job, the job will run at the ~ root folder instead.</p>

<p>To submit the job file (<em>myjobfile.pbs</em>), enter in the command:</p>

<div class="highlight highlight-source-shell"><pre>qsub myjobfile.pbs</pre></div>

<p>The cluster will then begin running the commands specified in the job file. The Hello World job above will run and finish extremely quickly, but if you are running a file that takes a longer amount of time, you will probably want to check the status of your jobs at some point. To check the status of your running jobs, you can enter in the command:</p>

<div class="highlight highlight-source-shell"><pre>pbsn -u username</pre></div>

<p>Here is a real-world example of a job file that runs a bam-indexing script (not pictured here) and forwards the error and logs to specified directories:</p>

<div class="highlight highlight-source-shell"><pre><span class="pl-c">#!/bin/bash</span>
<span class="pl-c">#PBS -N bam-index</span>
<span class="pl-c">#PBS -q medium   </span>
<span class="pl-c">#PBS -l nodes=1</span>
<span class="pl-c">#PBS -l cput=24:00:00        </span>
<span class="pl-c">#PBS -m bea</span>
<span class="pl-c">#PBS -M chenk8@mail.nih.gov</span>

<span class="pl-c1">cd</span> <span class="pl-smi">$PBS_O_WORKDIR</span>
./bam-index.sh <span class="pl-k">&gt;</span> <span class="pl-k">~</span>/err/<span class="pl-smi">$PBS_JOBID</span> <span class="pl-k">&gt;</span> <span class="pl-k">~</span>/logs/<span class="pl-smi">$PBS_JOBID</span>
<span class="pl-c1">exit</span> 0</pre></div>

<p><a href="https://hpcc.usc.edu/support/documentation/running-a-job-on-the-hpcc-cluster-using-pbs/">Further explanation on the various job script options can be found here.</a></p>

<hr>

<h1>
<a id="sample-workflow" class="anchor" href="#sample-workflow" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Sample workflow</h1>

<h2>
<a id="login-to-the-moab-hpc-cluster" class="anchor" href="#login-to-the-moab-hpc-cluster" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Login to the Moab HPC cluster</h2>

<p>Open your terminal and log in with your NIH username and password:</p>

<div class="highlight highlight-source-shell"><pre>ssh USERNAME@moab.ncifcrf.gov</pre></div>

<p>Then, open up an interactive job (so that the commands/scripts that you run
won't slow down the head node of the server):</p>

<div class="highlight highlight-source-shell"><pre>qsub -I</pre></div>

<p>Enter in <code>exit</code> if you ever want
to leave it.</p>

<p>Change to the lab directory:</p>

<div class="highlight highlight-source-shell"><pre><span class="pl-c1">cd</span> /ifs/projects/GRCBL-NGS/slowtemp</pre></div>

<h2>
<a id="start-a-project" class="anchor" href="#start-a-project" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Start a project</h2>

<p>Create a project directory:</p>

<div class="highlight highlight-source-shell"><pre>mkdir project1/
<span class="pl-c1">cd</span> project1/</pre></div>

<p>Create the cghub key:</p>

<div class="highlight highlight-source-shell"><pre>nano cghub.key</pre></div>

<p>Then copy and paste your TCGA key (in your email) into the folder, and enter Ctrl+X and then Y
to save.</p>

<p>Download basic TCGA and BAM scripts and set them as executable:</p>

<div class="highlight highlight-source-shell"><pre>git clone https://github.com/kevchn/tcga-cluster-scripts scripts/
chmod +x scripts/<span class="pl-k">*</span>.sh</pre></div>

<h2>
<a id="getting-your-tcga-authentication-token" class="anchor" href="#getting-your-tcga-authentication-token" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Getting your TCGA authentication token</h2>

<p>You will need an authentication token to download controlled data from TCGA (most raw-sequencing files). Minimize the terminal (but do not close it).</p>

<p>To generate a token, first log in to the <a href="https://gdc-portal.nci.nih.gov/">GDC Data Portal</a> by clicking the Login button in the top right corner of the page.</p>

<p>After logging in, clicking the username will open a drop-down menu. Select Download Token from the menu to generate an authentication token. Copy the contents of this token and save it <code>nano token.txt</code> in the project1/ directory.</p>

<h2>
<a id="finding-the-uuid-of-a-single-tcga-sample" class="anchor" href="#finding-the-uuid-of-a-single-tcga-sample" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Finding the UUID of a single TCGA sample</h2>

<p>Head to the <a href="https://gdc-portal.nci.nih.gov/search/s">Genomic Data Commons Data Portal</a></p>

<p>Click on any specific file to get more information, including its UUID (for example: 22a29915-6712-4f7a-8dba-985ae9a1f005)</p>

<h2>
<a id="downloading-a-single-tcga-file-onto-the-server" class="anchor" href="#downloading-a-single-tcga-file-onto-the-server" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Downloading a single TCGA file onto the server</h2>

<p>If you have the UUID of a single TCGA file, use the new <a href="https://gdc.nci.nih.gov/access-data/gdc-data-transfer-tool">gdc-data-transfer-tool</a>:</p>

<div class="highlight highlight-source-shell"><pre>module add gdc-client
gdc-client download 22a29915-6712-4f7a-8dba-985ae9a1f005 -t token.txt</pre></div>

<p>Please note that the NCI-ATRF cluster may not have the gdc-client installed, or it may be under a different name, in which case the above commands will not work. Enter in <code>module list</code> to see if there are any modules called gdc, genomic-data-commons, or similar, and import that module instead. If no modules exist, contact the NCI helpdesk to request that the program be installed.</p>

<p><a href="https://gdc.nci.nih.gov/access-data/gdc-data-transfer-tool">You can also download the gdc-client locally on your computer</a>.</p>

<h2>
<a id="download-a-list-of-desired-tcga-files" class="anchor" href="#download-a-list-of-desired-tcga-files" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Download a list of desired TCGA files</h2>

<p>Minimize the terminal (but do not close it), and head to the <a href="https://gdc-portal.nci.nih.gov/search/s">Genomic Data Commons Data Portal</a></p>

<p>Use the sidebar to filter out the desired samples. For example, if you want all
GBM RNA-seq samples, under the Cases tab, select Primary Site&gt;Brain and Project&gt;TCGA-GBM, and then under the Files tab, select Data Category&gt;Raw Sequencing Data and Experimental Strategy&gt;RNA-seq. The end-result should be 174 files.</p>

<p>Click the Download Manifest button to download an xml file containing the IDs of all these files (so that you can download them onto the cluster). <a href="https://gdc-docs.nci.nih.gov/Data_Transfer_Tool/Users_Guide/Preparing_for_Data_Download_and_Upload/">More information regarding how to download individual and multiple IDs from TCGA can be found here.</a></p>

<p>Open the xml file, copy the contents, and then open up terminal again.</p>

<p>In your project1/ folder, <code>nano manifest.xml</code> and paste in the XML information before saving (Ctrl+X, then Y).</p>

<h2>
<a id="bulk-downloading-tcga-files-onto-the-server" class="anchor" href="#bulk-downloading-tcga-files-onto-the-server" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Bulk downloading TCGA files onto the server</h2>

<p>Once you have the manifest.xml file, you can download the files using the new <a href="https://gdc.nci.nih.gov/access-data/gdc-data-transfer-tool">gdc-data-transfer-tool</a>:</p>

<div class="highlight highlight-source-shell"><pre>module add gdc-client
gdc-client download -m manifest.xml -t token.txt</pre></div>

<p>You will most likely want to do this using a job script, so that the cluster will download the files 24/7 until the files are all downloaded.</p>

<hr>

<h1>
<a id="running-this-repositorys-jobfiles-and-scripts" class="anchor" href="#running-this-repositorys-jobfiles-and-scripts" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Running this repository's jobfiles and scripts</h1>

<p>The following usage commands assume that you are in the parent directory of the scripts/ folder. If you are in a different directory, for example, projects1/data, you will have to provide either a different relative path for usage: <code>qsub ../scripts/index-bams.pbs</code> or an absolute path: <code>qsub /ifs/projects/GRCBL-NGS/slowtemp/project1/scripts/index-bams.pbs</code>.</p>

<h2>
<a id="scriptsindex-bamspbs" class="anchor" href="#scriptsindex-bamspbs" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>scripts/index-bams.pbs</h2>

<p>Indexes (and possibly sorts) all .bam files in the current directory</p>

<p>Creates .bai files for all .bam files in the current directory. Doesn't change the original .bam files. Need to ensure that the bam files are already sorted. TCGA files are usually sorted. To turn on sorting before indexing, <code>nano scripts/index-bams.pbs</code> and remove the '#' from line 15 and 16 and comment out line 17 like below:</p>

<div class="highlight highlight-source-shell"><pre>samtools sort <span class="pl-s"><span class="pl-pds">"</span><span class="pl-smi">${bamfile}</span><span class="pl-pds">"</span></span> <span class="pl-s"><span class="pl-pds">"</span><span class="pl-smi">${bamfile}</span>.sorted<span class="pl-pds">"</span></span>
samtools index <span class="pl-smi">${bamfile}</span>.sorted <span class="pl-k">&gt;</span> err/<span class="pl-smi">$PBS_JOBID</span> <span class="pl-k">&gt;</span> logs/<span class="pl-smi">$PBS_JOBID</span>
<span class="pl-c"># samtools index $bamfile &gt; err/$PBS_JOBID &gt; logs/$PBS_JOBID</span></pre></div>

<p>Usage:</p>

<ul>
<li><code>qsub scripts/index-bams.pbs</code></li>
</ul>

<p>Input:</p>

<ul>
<li>sample1.bam</li>
<li>sample2.bam</li>
<li>sample3.bam</li>
</ul>

<p>Returns:</p>

<ul>
<li>sample1.bai</li>
<li>sample2.bai</li>
<li>sample3.bai</li>
</ul>

<h2>
<a id="scriptsseparate-dif-len-bamspbs" class="anchor" href="#scriptsseparate-dif-len-bamspbs" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>scripts/separate-dif-len-bams.pbs</h2>

<p>Moves .bam files to new directories based on read-length and creates a summary of .bam file read-lengths</p>

<p>Checks the read-length of the .bam files by looking at the header of the bam files and then moves the files into a new directory based on that read-length. Removes bam-files with multiple read-lengths. Used for programs that can only run on multiple .bam files of the same read-length. Summary file, bam-information.txt, gives read-count and read-length of each bam-file.</p>

<p>Usage:</p>

<ul>
<li><code>qsub scripts/separate-dif-len-bams.pbs</code></li>
</ul>

<p>Input:</p>

<ul>
<li>sample1.bam</li>
<li>sample2.bam</li>
<li>sample3.bam</li>
</ul>

<p>Returns:</p>

<ul>
<li>bam-information.txt</li>
<li>bams-50/sample1.bam</li>
<li>bams-50/sample2.bam</li>
<li>bams-75/sample3.bam</li>
</ul>
      </section>
    </div>
    <footer>
      <p>Project maintained by <a href="https://github.com/kevchn">kevchn</a></p>
      <p>Hosted on GitHub Pages &mdash; Theme by <a href="https://github.com/orderedlist">orderedlist</a></p>
    </footer>
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->
    
  </body>
</html>
